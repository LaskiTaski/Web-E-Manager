{% load static %}
{% csrf_token %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Web-E Manager</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 2rem;
          background-color: #f4f4f9;
          color: #333;
      }

      h1 {
          color: #2c3e50;
          font-size: 2rem;
          display: flex;
          align-items: center;
          gap: 1rem;
      }

      h1::before {
          content: "üçΩ";
          font-size: 2rem;
      }

      button {
          background-color: #27ae60;
          color: white;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 5px;
          cursor: pointer;
      }

      button:hover {
          background-color: #219150;
      }

      .modal, .payment-modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content, .payment-content {
          background-color: #fff;
          margin: 5% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 70%;
          border-radius: 10px;
          position: relative;
      }

      .payment-content {
          z-index: 2;
          width: 300px;
          text-align: center;
      }

      .total-display {
          font-weight: bold;
          font-size: 1.2rem;
          margin-top: 1rem;
      }

      hr {
          border: 1px solid #ccc;
          margin: 2rem 0;
      }

      .tables-container {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 1.5rem;
          justify-items: center;
          margin-top: 2rem;
      }

      .table {
          width: 240px;
          height: 150px;
          background-color: #DCDCDC;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2rem;
          font-weight: bold;
          cursor: pointer;
          transition: background-color 0.3s;
      }

      .table.active {
          background-color: #BDECB6;
      }

      .tables-container .table:nth-child(7) {
          grid-column: 2;
      }

      .menu-search {
          position: sticky;
          top: 0;
          background: white;
          padding-bottom: 1rem;
          z-index: 10;
      }

      .menu-search input {
          width: 100%;
          padding: 0.5rem;
          font-size: 1rem;
          border: 1px solid #ccc;
          border-radius: 6px;
      }

      .menu-section {
          margin-bottom: 2rem;
      }

      .menu-section h3 {
          text-align: center;
          font-size: 1.2rem;
          margin: 1rem 0 0.5rem;
      }

      .menu-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 1rem;
      }

      .menu-item {
          border: 1px solid #ccc;
          border-radius: 8px;
          padding: 0.5rem;
          background: #fff;
          cursor: pointer;
          text-align: center;
      }

      .menu-item:hover {
          background-color: #d8f5d1;
      }

      .qty-modal {
          display: none;
          position: fixed;
          z-index: 2;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.4);
      }

      .qty-content {
          background-color: white;
          margin: 10% auto;
          padding: 1.5rem;
          width: 300px;
          border-radius: 10px;
          text-align: center;
      }

      .qty-controls {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          margin: 1rem 0;
      }

      .qty-controls input {
          width: 50px;
          text-align: center;
          font-size: 1.2rem;
      }

      .order-items {
          margin-bottom: 1rem;
      }

      .order-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 5px;
          background-color: #BDECB6;
          padding: 5px;
          border-radius: 5px;
      }

      .order-item span {
          margin: 0 5px;
      }

      .order-item button {
          background-color: #e74c3c;
          padding: 0 0.5rem;
          border-radius: 4px;
      }

      .menu-item.selected {
          background-color: #BDECB6;
      }


  </style>
</head>
<body>
<h1>EffectiveMobile</h1>
<hr>

<div class="tables-container">
  {% for i in "1234567" %}
    <div class="table" id="table-{{ i }}" onclick="handleTableClick({{ i }})">{{ i }}</div>
  {% endfor %}
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞–∫–∞–∑–∞ -->
<div class="modal" id="orderModal">
  <div class="modal-content">
    <h2 id="modal-title">–ó–∞–∫–∞–∑</h2>
    <form id="order-form">
      <p>–°—Ç–æ–ª ‚Ññ <span id="modal-table-number"></span></p>
      <div class="menu-search">
        <div class="order-items" id="order-items"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ ‚Äú–ú–µ–Ω—é‚Äù –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –±–ª—é–¥ -->
        <button type="button" onclick="toggleMenuSection()">–ú–µ–Ω—é</button>

        <!-- –ë–ª–æ–∫ –º–µ–Ω—é (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ ‚Äú–ú–µ–Ω—é‚Äù) -->
        <div id="menu-section-container" style="display:none">
          <div class="menu-search">
            <input type="text" id="menu-search" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞...">
          </div>
          <div id="menu-sections"></div>
        </div>

      </div>
      <div id="menu-sections"></div>
      <hr>
      <div class="total-display" id="total-display">–°—É–º–º–∞: 0 ‚ÇΩ</div>
      <br>
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="openPaymentModal()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
      <button type="button" onclick="closeOrderModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
<div class="qty-modal" id="qtyModal">
  <div class="qty-content">
    <h3 id="qtyDishName"></h3>
    <div class="qty-controls">
      <button type="button" onclick="adjustQty(-1)">‚àí</button>
      <input type="number" id="qtyInput" value="1" min="1">
      <button type="button" onclick="adjustQty(1)">+</button>
    </div>
    <button onclick="confirmQty()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <br><br>
    <button onclick="closeQtyModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-content">
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
    <button onclick="completePayment('cash')">–ù–∞–ª–∏—á–Ω—ã–µ</button>
    <button onclick="completePayment('card')">–ö–∞—Ä—Ç–æ–π</button>
    <br><br>
    <button onclick="closePaymentModal()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<script>
    const activeOrders = {};
    let currentEditingOrder = null;

    function handleTableClick(tableNumber) {
        const order = activeOrders[tableNumber];
        currentEditingOrder = order || {table_number: tableNumber, items: [], status: 'pending'};
        openOrderModal(currentEditingOrder);
    }

    function openOrderModal(order) {
        document.getElementById('orderModal').style.display = 'block';
        document.getElementById('modal-table-number').textContent = order.table_number;
        renderMenu();
    }

    function closeOrderModal() {
        document.getElementById('orderModal').style.display = 'none';
    }

    function updateTotalDisplay() {
        const total = currentEditingOrder.items.reduce((sum, item) => sum + item.price * (item.quantity || 1), 0);
        document.getElementById('total-display').textContent = –°—É–º–º–∞: ${total} ‚ÇΩ;
        renderOrderItems();
    }


    function toggleMenuSection() {
        const section = document.getElementById('menu-section-container');
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function renderOrderItems() {
        const container = document.getElementById('order-items');
        container.innerHTML = '';
        currentEditingOrder.items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'order-item';
            div.innerHTML =
      <span>${item.name}</span>
      <span>${item.price}‚ÇΩ</span>
      <span>x${item.quantity}</span>
      <button onclick="removeItem(${index})">√ó</button>
    ;
            container.appendChild(div);
        });
    }

    function removeItem(index) {
        currentEditingOrder.items.splice(index, 1);
        renderOrderItems();
        updateTotalDisplay();
    }


    async function loadActiveOrders() {
        const res = await fetch('/api/orders/');
        const data = await res.json();
        data.forEach(order => {
            if (order.status !== 'paid') {
                activeOrders[order.table_number] = order;
                const el = document.getElementById('table-' + order.table_number);
                if (el) el.classList.add('active');
            }
        });
    }

    function openPaymentModal() {
        document.getElementById('paymentModal').style.display = 'block';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }

    async function completePayment(method) {
        if (!currentEditingOrder) return;
        await fetch(/api/orders/${currentEditingOrder.id}/, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({status: 'paid'})
        });
        closePaymentModal();
        closeOrderModal();
        location.reload();
    }

    const fullMenu = {
        "–ö–æ—Ñ–µ –∏ —á–∞–π": [
            {"name": "–≠—Å–ø—Ä–µ—Å—Å–æ", "price": 150},
            {"name": "–ê–º–µ—Ä–∏–∫–∞–Ω–æ", "price": 180},
            {"name": "–ö–∞–ø—É—á–∏–Ω–æ", "price": 220},
            {"name": "–õ–∞—Ç—Ç–µ", "price": 250},
            {"name": "–†–∞—Ñ", "price": 280},
            {"name": "–§–ª—ç—Ç –£–∞–π—Ç", "price": 260},
            {"name": "–ú–æ–∫–∫–∞—á–∏–Ω–æ", "price": 290},
            {"name": "–ß–∞–π —á–µ—Ä–Ω—ã–π", "price": 120},
            {"name": "–ß–∞–π –∑–µ–ª–µ–Ω—ã–π", "price": 120},
            {"name": "–ß–∞–π —Ñ—Ä—É–∫—Ç–æ–≤—ã–π", "price": 150},
            {"name": "–ö–∞–∫–∞–æ", "price": 200},
            {"name": "–ì–ª–∏–Ω—Ç–≤–µ–π–Ω (–±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π)", "price": 350},
            {"name": "–ò–º–±–∏—Ä–Ω—ã–π —á–∞–π", "price": 200},
            {"name": "–û–±–ª–µ–ø–∏—Ö–æ–≤—ã–π —á–∞–π", "price": 250}

        ],
        "–•–æ–ª–æ–¥–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏": [
            {"name": "–°–≤–µ–∂–µ–≤—ã–∂–∞—Ç—ã–π –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π —Å–æ–∫", "price": 300},
            {"name": "–°–º—É–∑–∏ —è–≥–æ–¥–Ω—ã–π", "price": 350},
            {"name": "–í–æ–¥–∞ –º–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è (0.5–ª)", "price": 80},
            {"name": "–ö–æ–ª–∞ (0.33–ª)", "price": 150}
        ],
        "–í—ã–ø–µ—á–∫–∞ –∏ –¥–µ—Å–µ—Ä—Ç—ã": [
            {"name": "–ö—Ä—É–∞—Å—Å–∞–Ω –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π", "price": 180},
            {"name": "–ö—Ä—É–∞—Å—Å–∞–Ω —Å –º–∏–Ω–¥–∞–ª–µ–º", "price": 220},
            {"name": "–ú–∞—Ñ—Ñ–∏–Ω —à–æ–∫–æ–ª–∞–¥–Ω—ã–π", "price": 200},
            {"name": "–ß–∏–∑–∫–µ–π–∫ –ù—å—é-–ô–æ—Ä–∫", "price": 350},
            {"name": "–¢–∏—Ä–∞–º–∏—Å—É", "price": 380},
            {"name": "–≠–∫–ª–µ—Ä –≤–∞–Ω–∏–ª—å–Ω—ã–π", "price": 250},
            {"name": "–ú–µ–¥–æ–≤–∏–∫", "price": 320},
            {"name": "–ë—Ä–∞—É–Ω–∏", "price": 280},
            {"name": "–ü–µ—á–µ–Ω—å–µ –æ–≤—Å—è–Ω–æ–µ", "price": 80},
            {"name": "–°—ã—Ä–Ω–∏–∫–∏ —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π", "price": 300},
            {"name": "–ë–ª–∏–Ω—á–∏–∫–∏ —Å —Ç–≤–æ—Ä–æ–≥–æ–º", "price": 280},
            {"name": "–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Ç–æ—Ä—Ç", "price": 400},
            {"name": "–¢–≤–æ—Ä–æ–∂–Ω–∞—è –∑–∞–ø–µ–∫–∞–Ω–∫–∞", "price": 300},
            {"name": "–í–∞—Ñ–ª–∏ —Å –º–æ—Ä–æ–∂–µ–Ω—ã–º", "price": 300},

            {"name": "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (1 —à–∞—Ä–∏–∫)", "price": 120},
            {"name": "–ë–∞–Ω–∞–Ω–æ–≤—ã–π —Å–ø–ª–∏—Ç", "price": 400}
        ],
        "–°–∞–ª–∞—Ç—ã": [
            {"name": "–°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å —Å –∫—É—Ä–∏—Ü–µ–π", "price": 450},
            {"name": "–°–∞–ª–∞—Ç –ì—Ä–µ—á–µ—Å–∫–∏–π", "price": 400},
            {"name": "–°–∞–ª–∞—Ç –û–ª–∏–≤—å–µ", "price": 350}
        ],
        "–°—É–ø—ã": [
            {"name": "–¢–æ–º–∞—Ç–Ω—ã–π —Å—É–ø", "price": 300},
            {"name": "–ö—Ä–µ–º-—Å—É–ø –≥—Ä–∏–±–Ω–æ–π", "price": 350},
            {"name": "–ë–æ—Ä—â", "price": 320},
            {"name": "–°–æ–ª—è–Ω–∫–∞", "price": 380}
        ],
        "–ü–∞—Å—Ç–∞ –∏ –≥–∞—Ä–Ω–∏—Ä—ã": [
            {"name": "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞", "price": 500},
            {"name": "–ü–∞—Å—Ç–∞ –ë–æ–ª–æ–Ω—å–µ–∑–µ", "price": 520},
            {"name": "–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏", "price": 380},
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏", "price": 250},
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏", "price": 280}
        ],
        "–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞": [
            {"name": "–°—Ç–µ–π–∫ –∏–∑ –ª–æ—Å–æ—Å—è", "price": 750},
            {"name": "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –Ω–∞ –≥—Ä–∏–ª–µ", "price": 480},
            {"name": "–ë—É—Ä–≥–µ—Ä —Å –≥–æ–≤—è–¥–∏–Ω–æ–π", "price": 550},
            {"name": "–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∏–π –±—É—Ä–≥–µ—Ä", "price": 480},
            {"name": "–ñ–∞—Ä–∫–æ–µ –ø–æ-–¥–æ–º–∞—à–Ω–µ–º—É", "price": 450}

        ],
        "–ü–∏—Ü—Ü–∞ –∏ –∑–∞–∫—É—Å–∫–∏": [
            {"name": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞", "price": 600},
            {"name": "–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏", "price": 650},
            {"name": "–°—ç–Ω–¥–≤–∏—á —Å –∫—É—Ä–∏—Ü–µ–π –∏ –æ–≤–æ—â–∞–º–∏", "price": 350},
            {"name": "–†–æ–ª–ª —Å –ª–æ—Å–æ—Å–µ–º", "price": 400},
            {"name": "–°—ã—Ä–Ω–∞—è —Ç–∞—Ä–µ–ª–∫–∞", "price": 600},
            {"name": "–§—Ä—É–∫—Ç–æ–≤–∞—è —Ç–∞—Ä–µ–ª–∫–∞", "price": 550}
        ],
        "–ó–∞–≤—Ç—Ä–∞–∫–∏": [
            {"name": "–û–º–ª–µ—Ç —Å –≤–µ—Ç—á–∏–Ω–æ–π –∏ —Å—ã—Ä–æ–º", "price": 320},
            {"name": "–Ø–∏—á–Ω–∏—Ü–∞-–≥–ª–∞–∑—É–Ω—å—è (2 —è–π—Ü–∞)", "price": 150},
            {"name": "–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è —Å —Ñ—Ä—É–∫—Ç–∞–º–∏", "price": 250}
        ],

        "–í–æ—Å—Ç–æ—á–Ω–∞—è –∫—É—Ö–Ω—è": [
            {"name": "–®–∞—à–ª—ã–∫ –∏–∑ —Å–≤–∏–Ω–∏–Ω—ã", "price": 650},
            {"name": "–õ—é–ª—è-–∫–µ–±–∞–±", "price": 580},
            {"name": "–•–∞—á–∞–ø—É—Ä–∏ –ø–æ-–∞–¥–∂–∞—Ä—Å–∫–∏", "price": 450},
            {"name": "–•–∏–Ω–∫–∞–ª–∏ (5 —à—Ç)", "price": 400},
            {"name": "–ú–∞–Ω—Ç—ã (3 —à—Ç)", "price": 350},
            {"name": "–°–∞–º—Å–∞ —Å –º—è—Å–æ–º", "price": 250},
            {"name": "–ü–ª–æ–≤", "price": 480}

        ],
        "–î–æ–º–∞—à–Ω—è—è –∫—É—Ö–Ω—è": [
            {"name": "–í–∞—Ä–µ–Ω–∏–∫–∏ —Å –∫–∞—Ä—Ç–æ—à–∫–æ–π", "price": 300},
            {"name": "–ü–µ–ª—å–º–µ–Ω–∏ –¥–æ–º–∞—à–Ω–∏–µ", "price": 350},
            {"name": "–ì–æ–ª—É–±—Ü—ã", "price": 400}
        ],
        "–ê–ª–∫–æ–≥–æ–ª—å": [
            {"name": "–°–∏–¥—Ä", "price": 300}
        ]
    };

    function renderMenu(filter = '') {
        const container = document.getElementById("menu-sections");
        container.innerHTML = '';
        Object.entries(fullMenu).forEach(([category, items]) => {
            const filtered = items.filter(i => i.name.toLowerCase().includes(filter.toLowerCase()));
            if (filtered.length === 0) return;

            const section = document.createElement('div');
            section.className = 'menu-section';

            const title = document.createElement('h3');
            title.textContent = category;
            section.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'menu-grid';

            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'menu-item';
                el.textContent = ${item.name} - ${item.price}‚ÇΩ;
                el.classList.toggle('selected', !!currentEditingOrder.items.find(i => i.name === item.name));
                el.onclick = () => {
                    showQtyModal(item);
                };
                grid.appendChild(el);
            });

            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    document.getElementById('menu-search').addEventListener('input', () => {
        renderMenu(document.getElementById('menu-search').value);
    });

    document.getElementById('order-form').addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
            table_number: currentEditingOrder.table_number,
            items: currentEditingOrder.items,
            status: currentEditingOrder.status || 'pending'
        };
        const url = currentEditingOrder.id ? /api/orders/${currentEditingOrder.id}/ : '/api/orders/';
        const method = currentEditingOrder.id ? 'PATCH' : 'POST';
        await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify(data)
        });
        closeOrderModal();
        location.reload();
    });

    document.addEventListener('DOMContentLoaded', loadActiveOrders);

    let selectedDish = null;

    function showQtyModal(dish) {
        selectedDish = dish;
        document.getElementById('qtyDishName').textContent = dish.name;
        document.getElementById('qtyInput').value = 1;
        document.getElementById('qtyModal').style.display = 'block';
    }

    function closeQtyModal() {
        document.getElementById('qtyModal').style.display = 'none';
    }

    function adjustQty(delta) {
        const input = document.getElementById('qtyInput');
        let value = parseInt(input.value) || 1;
        value = Math.max(1, value + delta);
        input.value = value;
    }

    function confirmQty() {
        const qty = parseInt(document.getElementById('qtyInput').value) || 1;
        const existing = currentEditingOrder.items.find(i => i.name === selectedDish.name);
        if (!existing) {
            currentEditingOrder.items.push({...selectedDish, quantity: qty});
        } else {
            existing.quantity += qty;
        }
        closeQtyModal();
        updateTotalDisplay();
    }

</script>
</body>
</html>